# yamllint disable rule:line-length
rule_files:
  - prometheus_alerts.yaml

tests:
  - interval: 5m
    input_series:
      - series: 'kubernetes-autoscaling-mixin_migrations_unapplied_total{namespace="kubernetes-autoscaling-mixin", job="kubernetes-autoscaling-mixin"}'
        values: '1+0x4'
    alert_rule_test:
      - eval_time: 20m
        alertname: Kubernetes / AutoscalingMigrationsUnapplied
        exp_alerts:
          - exp_labels:
              namespace: kubernetes-autoscaling-mixin
              job: kubernetes-autoscaling-mixin
              severity: warning
            exp_annotations:
              summary: 'Kubernetes / Autoscaling has unapplied migrations.'
              description: 'The job kubernetes-autoscaling-mixin has unapplied migrations.'
              dashboard_url: 'https://grafana.com/d/kubernetes-autoscaling-mixin-overview-jkwq/kubernetes-autoscaling-mixin-overview?var-namespace=kubernetes-autoscaling-mixin&var-job=kubernetes-autoscaling-mixin'
  - interval: 1m
    input_series:
      - series: 'kubernetes-autoscaling-mixin_db_errors_total{namespace="kubernetes-autoscaling-mixin", job="kubernetes-autoscaling-mixin", type="IntegrityError"}'
        values: '1+1x20'
    alert_rule_test:
      - eval_time: 15m
        alertname: Kubernetes / AutoscalingDatabaseException
        exp_alerts:
          - exp_labels:
              namespace: kubernetes-autoscaling-mixin
              job: kubernetes-autoscaling-mixin
              severity: info
              type: IntegrityError
            exp_annotations:
              summary: 'Kubernetes / Autoscaling database exception.'
              description: 'The job kubernetes-autoscaling-mixin has hit the database exception IntegrityError.'
              dashboard_url: 'https://grafana.com/d/kubernetes-autoscaling-mixin-overview-jkwq/kubernetes-autoscaling-mixin-overview?var-namespace=kubernetes-autoscaling-mixin&var-job=kubernetes-autoscaling-mixin'
  - interval: 1m
    input_series:
      - series: 'kubernetes-autoscaling-mixin_http_responses_total_by_status_view_method_total{namespace="kubernetes-autoscaling-mixin", job="kubernetes-autoscaling-mixin", view="alert-test", status="200"}'
        values: '1+10x10'
      - series: 'kubernetes-autoscaling-mixin_http_responses_total_by_status_view_method_total{namespace="kubernetes-autoscaling-mixin", job="kubernetes-autoscaling-mixin", view="alert-test", status="403"}'
        values: '1+1x10'
    alert_rule_test:
      - eval_time: 10m
        alertname: Kubernetes / AutoscalingHighHttp4xxErrorRate
        exp_alerts:
          - exp_labels:
              namespace: kubernetes-autoscaling-mixin
              job: kubernetes-autoscaling-mixin
              severity: warning
              view: alert-test
            exp_annotations:
              summary: 'Kubernetes / Autoscaling high HTTP 4xx error rate.'
              description: 'More than 5% HTTP requests with status 4xx for kubernetes-autoscaling-mixin/alert-test the past 5m.'
              dashboard_url: 'https://grafana.com/d/kubernetes-autoscaling-mixin-requests-by-view-jkwq/kubernetes-autoscaling-mixin-requests-by-view?var-namespace=kubernetes-autoscaling-mixin&var-job=kubernetes-autoscaling-mixin&var-view=alert-test'
  - interval: 1m
    input_series:
      - series: 'kubernetes-autoscaling-mixin_http_responses_total_by_status_view_method_total{namespace="kubernetes-autoscaling-mixin", job="kubernetes-autoscaling-mixin", view="alert-test", status="200"}'
        values: '1+10x10'
      - series: 'kubernetes-autoscaling-mixin_http_responses_total_by_status_view_method_total{namespace="kubernetes-autoscaling-mixin", job="kubernetes-autoscaling-mixin", view="alert-test", status="503"}'
        values: '1+1x10'
    alert_rule_test:
      - eval_time: 10m
        alertname: Kubernetes / AutoscalingHighHttp5xxErrorRate
        exp_alerts:
          - exp_labels:
              namespace: kubernetes-autoscaling-mixin
              job: kubernetes-autoscaling-mixin
              severity: warning
              view: alert-test
            exp_annotations:
              summary: 'Kubernetes / Autoscaling high HTTP 5xx error rate.'
              description: 'More than 5% HTTP requests with status 5xx for kubernetes-autoscaling-mixin/alert-test the past 5m.'
              dashboard_url: 'https://grafana.com/d/kubernetes-autoscaling-mixin-requests-by-view-jkwq/kubernetes-autoscaling-mixin-requests-by-view?var-namespace=kubernetes-autoscaling-mixin&var-job=kubernetes-autoscaling-mixin&var-view=alert-test'
